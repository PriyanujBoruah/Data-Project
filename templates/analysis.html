{% extends "base.html" %}
{% block title %}Data Analysis{% endblock %}

{% block head_extra %}
    {# Include Plotly JS for rendering plots generated by the backend #}
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
    <style>
        .analysis-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: .3rem;
            background-color: #f8f9fa;
            box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
        }
        .analysis-section h4 {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #ced4da;
            color: #495057;
        }
        .analysis-subsection {
             border: 1px solid #e9ecef;
             border-radius: .25rem;
             padding: 1rem;
             margin-bottom: 1rem;
             background-color: #ffffff; /* White background for subsections */
        }
         .analysis-subsection h6 {
            color: #6c757d; /* Subdued color for subsection titles */
            margin-bottom: 0.75rem;
        }
        .plot-container {
            border: 1px solid #ddd;
            padding: 5px;
            margin-top: 1rem;
            background-color: white;
            overflow-x: auto;
        }
        .stats-table table, .crosstab-table table, .groupby-table table, .model-metrics-table table, .model-coeffs-table table {
            font-size: 0.85em;
            margin-top: 1rem;
        }
        .model-results pre { /* Style for classification report */
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            padding: 10px;
            font-size: 0.8em;
            overflow-x: auto;
            border-radius: .2rem;
        }
        select[multiple] {
            min-height: 120px;
            border-radius: .2rem;
        }
        .analysis-section .form-label {
             font-size: 0.9em;
             font-weight: 500;
             margin-bottom: 0.25rem; /* Less space below label */
        }
        .analysis-section .mb-3 {
             margin-bottom: 1rem !important;
        }


    </style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Data Analysis: {{ filename }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('clean_data') }}" class="btn btn-sm btn-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left-square-fill me-1" viewBox="0 0 16 16"><path d="M16 14a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12zm-4.5-6.5H5.707l2.147-2.146a.5.5 0 1 0-.708-.708l-3 3a.5.5 0 0 0 0 .708l3 3a.5.5 0 0 0 .708-.708L5.707 8.5H11.5a.5.5 0 0 0 0-1z"/></svg>
            Back to Cleaning
        </a>
    </div>
</div>
<p class="text-muted mb-4">Current Data Shape: {{ current_shape[0] }} Rows × {{ current_shape[1] }} Columns</p>

{# Display general errors from analysis generation #}
{% if error %}
    <div class="alert alert-danger" role="alert">
      Analysis Error: {{ error }}
    </div>
{% endif %}


<!-- ============================== -->
<!-- == Single Variable Analysis == -->
<!-- ============================== -->
<div class="analysis-section">
    <h4>Single Variable Analysis</h4>
    <form method="get" action="{{ url_for('analyze_data') }}">
        <input type="hidden" name="action" value="single_variable">
        <div class="mb-3">
            <label for="single_column_select" class="form-label">Select Column:</label>
            <select name="single_column" id="single_column_select" class="form-select form-select-sm" required>
                <option value="" disabled {% if not single_col_name %}selected{% endif %}>-- Choose a column --</option>
                {% for col in all_columns %}
                    <option value="{{ col }}" {% if col == single_col_name %}selected{% endif %}>{{ col }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary btn-sm">Analyze Column</button>
    </form>

    {# Display Area for Single Variable Results #}
    {% if action_performed == 'single_variable' and single_col_name %}
        <hr class="my-4">
        <h5>Results for: <code>{{ single_col_name }}</code></h5> {# Used code tag #}

        {# Numeric Results #}
        {% if single_col_name in numeric_cols %}
            {% if single_num_stats %}
                <div class="analysis-subsection">
                    <h6>Numeric Statistics:</h6>
                    <div class="stats-table table-responsive">
                        <table class="table table-sm table-bordered table-striped"><tbody>
                            {% for key, value in single_num_stats.items() %}
                            <tr><th style="width: 35%;">{{ key|replace('_', ' ')|title }}</th><td>{{ value }}</td></tr> {# Formatted key #}
                            {% endfor %}
                        </tbody></table>
                    </div>
                </div>
            {% endif %}
            <div class="row">
                <div class="col-lg-6"> {% if single_num_hist_div %}<div class="plot-container">{{ single_num_hist_div | safe }}</div>{% endif %}</div>
                <div class="col-lg-6"> {% if single_num_box_div %}<div class="plot-container">{{ single_num_box_div | safe }}</div>{% endif %}</div>
            </div>
        {% endif %}

        {# Categorical Results #}
        {% if single_col_name in categorical_cols %}
             {% if single_cat_table_html %}
                <div class="analysis-subsection">
                    <h6>Value Counts & Percentages:</h6>
                    <div class="stats-table table-responsive">{{ single_cat_table_html | safe }}</div>
                </div>
            {% endif %}
             {% if single_cat_bar_div %}
                <div class="plot-container">{{ single_cat_bar_div | safe }}</div>
            {% endif %}
        {% endif %}

        {# Datetime Results #}
         {% if single_col_name in datetime_cols %}
             {% if single_dt_stats %}
                <div class="analysis-subsection">
                    <h6>Date/Time Summary:</h6>
                    <div class="stats-table table-responsive">
                        <table class="table table-sm table-bordered table-striped"><tbody>
                            {% for key, value in single_dt_stats.items() %}
                            <tr><th style="width: 35%;">{{ key|replace('_', ' ')|title }}</th><td>{{ value }}</td></tr>
                            {% endfor %}
                        </tbody></table>
                    </div>
                </div>
            {% endif %}
             {% if single_dt_plot_div %}
                 <div class="plot-container">{{ single_dt_plot_div | safe }}</div>
            {% endif %}
        {% endif %}

        {# Fallback message #}
        {% if not single_num_stats and not single_cat_table_html and not single_dt_stats %}
             <p class="text-muted mt-3 fst-italic">No analysis results generated for this column type or data.</p>
        {% endif %}

    {% endif %}
</div>


<!-- =========================== -->
<!-- == Bivariate Analysis == -->
<!-- =========================== -->
<div class="analysis-section">
    <h4>Relationship Analysis (Two Variables)</h4>

    {# --- Numeric vs Numeric --- #}
    <div class="analysis-subsection">
        <h6>Numeric vs. Numeric (Scatter Plot & Correlation)</h6>
        <form method="get" action="{{ url_for('analyze_data') }}">
             <input type="hidden" name="action" value="numeric_vs_numeric">
            <div class="row g-2">
                <div class="col-md-6 mb-2"><label for="scatter_x_select" class="form-label">X-Axis:</label><select name="scatter_x" id="scatter_x_select" class="form-select form-select-sm" required><option value="" disabled {% if not scatter_col_x %}selected{% endif %}>-- Numeric --</option>{% for col in numeric_cols %}<option value="{{ col }}" {% if col == scatter_col_x %}selected{% endif %}>{{ col }}</option>{% endfor %}</select></div>
                <div class="col-md-6 mb-2"><label for="scatter_y_select" class="form-label">Y-Axis:</label><select name="scatter_y" id="scatter_y_select" class="form-select form-select-sm" required><option value="" disabled {% if not scatter_col_y %}selected{% endif %}>-- Numeric --</option>{% for col in numeric_cols %}<option value="{{ col }}" {% if col == scatter_col_y %}selected{% endif %}>{{ col }}</option>{% endfor %}</select></div>
            </div>
            <button type="submit" class="btn btn-primary btn-sm mt-2">Generate Scatter Plot</button>
        </form>
        {% if action_performed == 'numeric_vs_numeric' and scatter_col_x and scatter_col_y %}
            {% if scatter_results %}
                <div class="mt-3 mb-1 small">
                    <strong>Pearson Correlation:</strong> {{ scatter_results.correlation_pearson }} (p-value: {{ scatter_results.p_value_pearson }})<br>
                    <strong>Spearman Correlation:</strong> {{ scatter_results.correlation_spearman }}
                </div>
            {% endif %}
            {% if scatter_plot_div %}
                <div class="plot-container">{{ scatter_plot_div | safe }}</div>
            {% else %} <p class="text-muted mt-3 fst-italic">Could not generate scatter plot.</p> {% endif %}
        {% endif %}
    </div>

    {# --- Numeric vs Categorical --- #}
     <div class="analysis-subsection">
        <h6>Numeric vs. Categorical (Distribution Comparison)</h6>
        <form method="get" action="{{ url_for('analyze_data') }}">
             <input type="hidden" name="action" value="numeric_vs_categorical">
            <div class="row g-2">
                 <div class="col-md-6 mb-2"><label for="num_cat_numeric_select" class="form-label">Numeric Variable (Y-Axis):</label><select name="num_cat_numeric" id="num_cat_numeric_select" class="form-select form-select-sm" required><option value="" disabled {% if not num_cat_num_col %}selected{% endif %}>-- Numeric --</option>{% for col in numeric_cols %}<option value="{{ col }}" {% if col == num_cat_num_col %}selected{% endif %}>{{ col }}</option>{% endfor %}</select></div>
                 <div class="col-md-6 mb-2"><label for="num_cat_categorical_select" class="form-label">Categorical Variable (X-Axis):</label><select name="num_cat_categorical" id="num_cat_categorical_select" class="form-select form-select-sm" required><option value="" disabled {% if not num_cat_cat_col %}selected{% endif %}>-- Categorical --</option>{% for col in low_cardinality_cols %}<option value="{{ col }}" {% if col == num_cat_cat_col %}selected{% endif %}>{{ col }}</option>{% endfor %}</select><small class="form-text text-muted">Low cardinality columns shown.</small></div>
            </div>
            <button type="submit" class="btn btn-primary btn-sm mt-2">Generate Comparison Plots</button>
        </form>
         {% if action_performed == 'numeric_vs_categorical' and num_cat_num_col and num_cat_cat_col %}
            <div class="row mt-3">
                <div class="col-lg-6"> {% if num_cat_box_div %}<div class="plot-container">{{ num_cat_box_div | safe }}</div>{% else %}<p class="text-muted fst-italic small">Box plot not generated.</p>{% endif %}</div>
                <div class="col-lg-6"> {% if num_cat_violin_div %}<div class="plot-container">{{ num_cat_violin_div | safe }}</div>{% else %}<p class="text-muted fst-italic small">Violin plot not generated.</p>{% endif %}</div>
            </div>
        {% endif %}
    </div>

    {# --- Categorical vs Categorical --- #}
     <div class="analysis-subsection">
        <h6>Categorical vs. Categorical (Cross-Tabulation & Test)</h6>
        <form method="get" action="{{ url_for('analyze_data') }}">
             <input type="hidden" name="action" value="categorical_vs_categorical">
             <div class="row g-2">
                 <div class="col-md-6 mb-2"><label for="cat_cat_1_select" class="form-label">Category 1 (Rows):</label><select name="cat_cat_1" id="cat_cat_1_select" class="form-select form-select-sm" required><option value="" disabled {% if not cat_cat_col1 %}selected{% endif %}>-- Categorical --</option>{% for col in low_cardinality_cols %}<option value="{{ col }}" {% if col == cat_cat_col1 %}selected{% endif %}>{{ col }}</option>{% endfor %}</select></div>
                 <div class="col-md-6 mb-2"><label for="cat_cat_2_select" class="form-label">Category 2 (Columns):</label><select name="cat_cat_2" id="cat_cat_2_select" class="form-select form-select-sm" required><option value="" disabled {% if not cat_cat_col2 %}selected{% endif %}>-- Categorical --</option>{% for col in low_cardinality_cols %}<option value="{{ col }}" {% if col == cat_cat_col2 %}selected{% endif %}>{{ col }}</option>{% endfor %}</select></div>
            </div>
            <small class="form-text text-muted d-block mb-2">Low cardinality columns shown.</small>
            <button type="submit" class="btn btn-primary btn-sm">Generate Cross-Tab & Chi² Test</button>
        </form>
         {% if action_performed == 'categorical_vs_categorical' and cat_cat_col1 and cat_cat_col2 %}
            <div class="row mt-3">
                <div class="col-lg-7">
                    {% if crosstab_html %}
                        <h6 class="mt-0">Cross-Tabulation (Counts):</h6>
                        <div class="crosstab-table table-responsive">{{ crosstab_html | safe }}</div>
                    {% else %}<p class="text-muted fst-italic">Could not generate cross-tabulation.</p>{% endif %}
                </div>
                 <div class="col-lg-5">
                    {% if chi2_test_results %}
                        <h6>Chi-Squared Test of Independence:</h6>
                        <ul class="list-unstyled small">
                            <li><strong>Chi² Statistic:</strong> {{ chi2_test_results.chi2_statistic }}</li>
                            <li><strong>P-value:</strong> {{ chi2_test_results.p_value }}</li>
                            <li><strong>Degrees of Freedom:</strong> {{ chi2_test_results.dof }}</li>
                            <li><strong>Interpretation (α=0.05):</strong> {{ chi2_test_results.interpretation }}</li>
                            {% if chi2_test_results.warning %} <li class="text-warning"><small>{{ chi2_test_results.warning }}</small></li> {% endif %}
                        </ul>
                    {% else %}<p class="text-muted fst-italic small">Chi-squared test not performed.</p>{% endif %}
                     {% if crosstab_heatmap_div %}
                        <div class="plot-container mt-2">{{ crosstab_heatmap_div | safe }}</div>
                     {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>


<!-- ============================== -->
<!-- == Numeric Variable Overview == -->
<!-- ============================== -->
<div class="analysis-section">
    <h4>Numeric Overview: Correlation Heatmap</h4>
    <form method="get" action="{{ url_for('analyze_data') }}">
        <input type="hidden" name="action" value="correlation_heatmap">
        <div class="row g-2 align-items-end">
            <div class="col-auto">
                 <label for="corr_method_select" class="form-label">Method:</label>
                 <select name="corr_method" id="corr_method_select" class="form-select form-select-sm">
                     <option value="pearson" {% if correlation_method == 'pearson' or not correlation_method %}selected{% endif %}>Pearson (Linear)</option>
                     <option value="spearman" {% if correlation_method == 'spearman' %}selected{% endif %}>Spearman (Monotonic)</option>
                     <option value="kendall" {% if correlation_method == 'kendall' %}selected{% endif %}>Kendall (Ordinal)</option>
                 </select>
            </div>
             <div class="col-auto">
                <button type="submit" class="btn btn-primary btn-sm" {% if not numeric_cols or numeric_cols|length < 2 %}disabled title="Requires at least 2 numeric columns"{% endif %}>
                    Show Heatmap
                </button>
             </div>
            <div class="col-auto">
                 {% if numeric_cols|length < 2 %}<small class="text-warning"> (Requires ≥ 2 numeric columns)</small>{% endif %}
             </div>
        </div>
    </form>
     {% if action_performed == 'correlation_heatmap' %}
            {% if correlation_heatmap_div %}
                <div class="plot-container">{{ correlation_heatmap_div | safe }}</div>
            {% else %}<p class="text-muted mt-3 fst-italic">Could not generate correlation heatmap.</p>{% endif %}
     {% endif %}
</div>


<!-- ============================== -->
<!-- == Grouped Summaries == -->
<!-- ============================== -->
<div class="analysis-section">
     <h4>Grouped Summaries</h4>
    <form method="get" action="{{ url_for('analyze_data') }}">
         <input type="hidden" name="action" value="grouped_summary">
         <div class="row g-3">
             <div class="col-lg-4 col-md-6">
                 <label for="groupby_cols_select" class="form-label">Group By Column(s):</label>
                 <select name="groupby_cols" id="groupby_cols_select" class="form-select form-select-sm" multiple required>
                    {% for col in categorical_cols %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
                 </select>
                  <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple.</small>
             </div>
             <div class="col-lg-4 col-md-6">
                  <label for="groupby_vals_select" class="form-label">Calculate Value(s) For:</label>
                 <select name="groupby_vals" id="groupby_vals_select" class="form-select form-select-sm" multiple required>
                    {% for col in numeric_cols %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
                 </select>
                 <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple.</small>
             </div>
              <div class="col-lg-4 col-md-12">
                  <label for="groupby_funcs_select" class="form-label">Using Function(s):</label>
                 <select name="groupby_funcs" id="groupby_funcs_select" class="form-select form-select-sm" multiple required>
                     <option value="mean">Mean</option> <option value="median">Median</option> <option value="sum">Sum</option>
                     <option value="count">Count</option> <option value="std">Std Dev</option> <option value="min">Min</option>
                     <option value="max">Max</option> <option value="nunique">Unique Count</option>
                 </select>
                 <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple.</small>
             </div>
        </div>
        <button type="submit" class="btn btn-primary btn-sm mt-3">Generate Summary Table</button>
    </form>

     {% if action_performed == 'grouped_summary' %}
            {% if groupby_table_html %}
                 <h6 class="mt-3">Grouped Summary Results:</h6>
                <div class="groupby-table table-responsive">{{ groupby_table_html | safe }}</div>
            {% else %} <p class="text-muted mt-3 fst-italic">Could not generate grouped summary (check selections).</p> {% endif %}
     {% endif %}
</div>

<!-- ============================== -->
<!-- == Hypothesis Testing == -->
<!-- ============================== -->
<div class="analysis-section">
    <h4>Hypothesis Testing</h4>
     <p class="small text-muted">Basic statistical tests. Ensure data meets test assumptions (e.g., normality, variance) for valid interpretation.</p>

     {# --- Independent T-Test --- #}
    <div class="analysis-subsection">
        <h6>Independent Samples T-Test (Compare Means of Two Groups)</h6>
         <form method="get" action="{{ url_for('analyze_data') }}">
             <input type="hidden" name="action" value="ttest">
             <div class="row g-2">
                 <div class="col-md-6 mb-2">
                     <label for="ttest_numeric_select" class="form-label">Numeric Variable:</label>
                     <select name="ttest_numeric" id="ttest_numeric_select" class="form-select form-select-sm" required>
                         <option value="" disabled {% if not ttest_num_col %}selected{% endif %}>-- Numeric --</option>
                         {% for col in numeric_cols %}<option value="{{ col }}" {% if col == ttest_num_col %}selected{% endif %}>{{ col }}</option>{% endfor %}
                     </select>
                 </div>
                  <div class="col-md-6 mb-2">
                     <label for="ttest_cat_binary_select" class="form-label">Grouping Variable (Binary):</label>
                     <select name="ttest_cat_binary" id="ttest_cat_binary_select" class="form-select form-select-sm" required>
                         <option value="" disabled {% if not ttest_cat_col %}selected{% endif %}>-- Categorical (2 Groups) --</option>
                          {# Populate with columns that *might* be binary - backend validation is key #}
                         {% for col in low_cardinality_cols %}<option value="{{ col }}" {% if col == ttest_cat_col %}selected{% endif %}>{{ col }}</option>{% endfor %}
                     </select>
                     <small class="form-text text-muted">Select column with exactly 2 groups.</small>
                 </div>
            </div>
            <button type="submit" class="btn btn-primary btn-sm mt-2">Perform T-Test</button>
         </form>
         {% if action_performed == 'ttest' and ttest_num_col and ttest_cat_col %}
            <div class="mt-3">
                <h6>T-Test Results ({{ ttest_num_col }} by {{ ttest_cat_col }}):</h6>
                 {% if ttest_results %}
                 <ul class="list-unstyled small">
                    <li><strong>Groups Compared:</strong> {{ ttest_results.groups_compared }}</li>
                    <li><strong>T-Statistic:</strong> {{ ttest_results.statistic }}</li>
                    <li><strong>P-value:</strong> {{ ttest_results.p_value }}</li>
                    <li class="fw-bold">Interpretation (α=0.05): {{ ttest_results.interpretation }}</li>
                    {% if ttest_results.warning %} <li class="text-warning"><small>{{ ttest_results.warning }}</small></li> {% endif %}
                 </ul>
                 {% else %} <p class="text-danger fst-italic small">T-Test could not be performed.</p> {% endif %}
             </div>
         {% endif %}
    </div>

     {# --- ANOVA --- #}
    <div class="analysis-subsection">
        <h6>One-Way ANOVA (Compare Means of 3+ Groups)</h6>
         <form method="get" action="{{ url_for('analyze_data') }}">
             <input type="hidden" name="action" value="anova">
             <div class="row g-2">
                 <div class="col-md-6 mb-2">
                     <label for="anova_numeric_select" class="form-label">Numeric Variable:</label>
                     <select name="anova_numeric" id="anova_numeric_select" class="form-select form-select-sm" required>
                          <option value="" disabled {% if not anova_num_col %}selected{% endif %}>-- Numeric --</option>
                         {% for col in numeric_cols %}<option value="{{ col }}" {% if col == anova_num_col %}selected{% endif %}>{{ col }}</option>{% endfor %}
                     </select>
                 </div>
                  <div class="col-md-6 mb-2">
                     <label for="anova_cat_multi_select" class="form-label">Grouping Variable (≥2 Groups):</label>
                     <select name="anova_cat_multi" id="anova_cat_multi_select" class="form-select form-select-sm" required>
                         <option value="" disabled {% if not anova_cat_col %}selected{% endif %}>-- Categorical --</option>
                         {% for col in low_cardinality_cols %}<option value="{{ col }}" {% if col == anova_cat_col %}selected{% endif %}>{{ col }}</option>{% endfor %}
                     </select>
                     <small class="form-text text-muted">Select column with 2 or more groups.</small>
                 </div>
            </div>
            <button type="submit" class="btn btn-primary btn-sm mt-2">Perform ANOVA</button>
         </form>
         {% if action_performed == 'anova' and anova_num_col and anova_cat_col %}
            <div class="mt-3">
                <h6>ANOVA Results ({{ anova_num_col }} by {{ anova_cat_col }}):</h6>
                 {% if anova_results %}
                 <ul class="list-unstyled small">
                    <li><strong>Number of Groups Found:</strong> {{ anova_results.num_groups }}</li>
                    <li><strong>F-Statistic:</strong> {{ anova_results.statistic }}</li>
                    <li><strong>P-value:</strong> {{ anova_results.p_value }}</li>
                    <li class="fw-bold">Interpretation (α=0.05): {{ anova_results.interpretation }}</li>
                    {% if anova_results.warning %} <li class="text-warning"><small>{{ anova_results.warning }}</small></li> {% endif %}
                 </ul>
                 {% else %} <p class="text-danger fst-italic small">ANOVA could not be performed.</p> {% endif %}
             </div>
         {% endif %}
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
// Function to disable the selected target column in the feature multi-select list
function updateFeatureOptions(targetSelectId, featureSelectId) {
    const targetSelect = document.getElementById(targetSelectId);
    const featureSelect = document.getElementById(featureSelectId);
    if (!targetSelect || !featureSelect) {
        console.error("Target or Feature select element not found for JS update.");
        return;
    }
    const selectedTargetValue = targetSelect.value;

    // Loop through options in the feature select box
    for (let i = 0; i < featureSelect.options.length; i++) {
        const option = featureSelect.options[i];
        if (option.value === selectedTargetValue) {
            option.disabled = true;
            // Optional: Deselect if it was selected
            if (option.selected) {
                option.selected = false;
            }
        } else {
            option.disabled = false;
        }
    }
}

// Call once on load for regression to disable initially selected target (if any)
document.addEventListener('DOMContentLoaded', () => {
     updateFeatureOptions('regression_target_select', 'regression_features_select');
     updateFeatureOptions('classification_target_select', 'classification_features_select');

    // Add event listeners to the outlier form elements again (copied from base clean.html logic)
    const methodSelect = document.getElementById('outlier_method'); // This element is NOT on analysis.html
    if (methodSelect) {
         const thresholdInput = document.getElementById('outlier_threshold');
         const thresholdLabel = document.getElementById('outlier_threshold_label');
         const thresholdHelp = document.getElementById('outlier_threshold_help');
         const actionSelect = document.getElementById('outlier_action');
         const actionHelp = document.getElementById('outlier_action_help');
         if (thresholdInput && thresholdLabel && thresholdHelp && actionSelect && actionHelp) {
             methodSelect.addEventListener('change', function() { /* ... (outlier help text logic) ... */ });
             methodSelect.dispatchEvent(new Event('change')); // Trigger on load
         }
    }

});

</script>
{% endblock %}
